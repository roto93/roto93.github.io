<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"roto93.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.13.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜尋...","empty":"我們無法找到任何有關 ${query} 的搜索結果","hits_time":"${hits} 找到 ${time} 個結果","hits":"找到 ${hits} 個結果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="一些程式自學小記錄">
<meta property="og:type" content="website">
<meta property="og:title" content="Pi&#39;s Blog">
<meta property="og:url" content="http://roto93.github.io/page/8/index.html">
<meta property="og:site_name" content="Pi&#39;s Blog">
<meta property="og:description" content="一些程式自學小記錄">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="Guan-Ting Su">
<meta property="article:tag" content="程式,自學">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://roto93.github.io/page/8/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-TW","comments":"","permalink":"","path":"page/8/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Pi's Blog</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Pi's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Guan-Ting Su</p>
  <div class="site-description" itemprop="description">一些程式自學小記錄</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">45</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="回到頂端">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://roto93.github.io/2021/07/28/%E4%B8%8D%E5%BB%BA%E8%AD%B0%E5%9C%A8Heroku%E4%B8%8A%E7%94%A8sqlite%E7%95%B6DB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Guan-Ting Su">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pi's Blog">
      <meta itemprop="description" content="一些程式自學小記錄">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Pi's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/28/%E4%B8%8D%E5%BB%BA%E8%AD%B0%E5%9C%A8Heroku%E4%B8%8A%E7%94%A8sqlite%E7%95%B6DB/" class="post-title-link" itemprop="url">不建議在 Heroku 上用 SQLite 當 DB?</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2021-07-28 23:40:07" itemprop="dateCreated datePublished" datetime="2021-07-28T23:40:07+08:00">2021-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2022-10-13 15:53:16" itemprop="dateModified" datetime="2022-10-13T15:53:16+08:00">2022-10-13</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <font size="2" color="#aaa">

<h2 id="前言-中言-後言"><a href="#前言-中言-後言" class="headerlink" title="前言+中言+後言"></a><font color="#f4a261">前言+中言+後言</font></h2><p>這會是個小短篇<br>在前兩篇文章中我介紹了怎麼用 python flask 架設 api </p>
<p>於是接下來我就在研究要如何<br>串接 sqlite 資料庫後放到 Heroku 上運作</p>
<p>研究途中想到個問題<br>就是 api 如果經過 POST 請求修改了資料庫<br>那在雲端更新的資料要怎麼抓下來到本地中?</p>
<p>我試了 <code>git pull heroku main</code></p>
<p>但它卻告訴我 Already up to date.</p>
<p><a target="_blank" rel="noopener" href="https://devcenter.heroku.com/articles/sqlite3">Heroku Dev Center的一篇文章</a> 有提到這件事<br>他說 sqlite 雖然方便又適合新手，但不建議用在 production</p>
<blockquote>
<p>SQLite runs in memory, and backs up its data store in files on disk. While this strategy works well for development, Heroku’s Cedar stack has an ephemeral filesystem. You can write to it, and you can read from it, but the contents will be cleared periodically. If you were to use SQLite on Heroku, you would lose your entire database at least once every 24 hours.</p>
</blockquote>
<p>意思是 SQLite 在記憶體運作，每隔一段時間 Heroku 就會把它清除</p>
<blockquote>
<p>Even if Heroku’s disks were persistent running SQLite would still not be a good fit. Since SQLite does not run as a service, each dyno would run a separate running copy. Each of these copies need their own disk backed store. This would mean that each dyno powering your app would have a different set of data since the disks are not synchronized.</p>
</blockquote>
<p>老實說這一段我不懂，但看到一些關鍵字說會發生每個 dyno (這啥)都有不同的 data set 的情形發生</p>
<p>所以他們推薦使用 Postgresql</p>
<p>那我就學這個吧我想應該就一些前置作業的不同吧<br>畢竟都是要用 ORM 來操作</p>
</font>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://roto93.github.io/2021/07/28/%E7%94%A8Python-Flask%E6%89%93%E9%80%A0API-DB%E7%AF%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Guan-Ting Su">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pi's Blog">
      <meta itemprop="description" content="一些程式自學小記錄">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Pi's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/28/%E7%94%A8Python-Flask%E6%89%93%E9%80%A0API-DB%E7%AF%87/" class="post-title-link" itemprop="url">用 Python Flask 打造 API - DB 篇</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2021-07-28 09:55:13" itemprop="dateCreated datePublished" datetime="2021-07-28T09:55:13+08:00">2021-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2022-10-13 15:53:16" itemprop="dateModified" datetime="2022-10-13T15:53:16+08:00">2022-10-13</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <font size="2" color="#aaa">


<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a><font color="#f4a261">前言</font></h2><p>繼前一篇用 Flask 建立簡單的 API<br>我把大部分篇幅用來介紹我為什麼要做，為什麼選flask的心路歷程<br>以及前置作業上<br>這篇則會把來不及提到的資料庫環節記錄下來</p>
<p>先回顧一下前一篇的程式樣貌<br>僅定義了啟動 app 和根路徑的 GET 方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>) </span><span class="comment"># Decorator。 在這個路徑下接收到 request (預設為GET) 的話要做以下的事</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello world from Flask&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:   <span class="comment"># 當這份程式被作為主程式執行時</span></span><br><span class="line">    app.run(debug=Ture)   <span class="comment"># 執行app，debug=True會讓app處於監聽狀態</span></span><br></pre></td></tr></table></figure>

<h2 id="建立-sqlite-database"><a href="#建立-sqlite-database" class="headerlink" title="建立 sqlite database"></a><font color="#f4a261">建立 sqlite database</font></h2><p>為了在 flask 中操作資料庫<br>我們需要使用 flask_sqlalchemy 模組<br><code>pip install flask_sqlalchemy</code><br>接著在 app.py 中<br><code>from flask_sqlalchemy import SQLAlchemy</code></p>
<p>並且我們會使用 ORM 的技術來操作資料庫 (這裡我們選擇輕量的資料庫:sqlite)</p>
<p>ORM 是 Object Relational Mapping(物件關聯對映)<br>一句話解釋就是</p>
<blockquote>
<p>用操作物件的方式操作資料庫</p>
</blockquote>
<p>這樣即使我們不用 SQL 語法，也可以使用 SQL 資料庫了<br>開始建立資料庫!</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 設定要連線的資料庫</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;sqlite:///data.db&#x27;</span></span><br><span class="line">db = SQLAlchemy(app) <span class="comment"># 宣告 db</span></span><br></pre></td></tr></table></figure>

<p><code>&#39;SQLALCHEMY_DATABASE_URI&#39;</code>這個參數是告訴app你要跟什麼資料庫連接<br>以我們的例子是用 sqlite，所以設為<code>sqlite:///data.db</code><br>注意有三個斜線 它的意思是相對路經<br>後面的<code>data.db</code>是你待會要創建的 db 的檔案名稱</p>
<p>如同剛剛說的 ORM 是以操作物件的方式進行<br>我們需要新增一個 class 作為資料庫的 model</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Issue</span>(db.model): <span class="comment"># 宣告一個類別，這個類別繼承 db.Model</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>) <span class="comment"># 宣告一個id欄位，型別為db.Integer，</span></span><br><span class="line">    name = db.Column(db.String(<span class="number">80</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>) <span class="comment"># 宣告一個name欄位</span></span><br><span class="line">    content = db.Column(db.String(<span class="number">20000</span>)) <span class="comment"># 宣告一個 content 欄位</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;self.name&#125;</span> - <span class="subst">&#123;self.content&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>接下來我們回到 terminal 輸入 <code>python</code><br>以打開 python 的 interactive prompt</p>
<p>假如說我想在 API 中存放 TAN 網站的 email 文字檔<br>那我就把每一份文字檔都叫作 issue 好了<br>逐一輸入以下代碼</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> db  <span class="comment"># 引入db模組</span></span><br><span class="line">db.create_all() <span class="comment"># 建立db，會生成一個 data.db 檔案</span></span><br><span class="line">issue = Issue(name=<span class="string">&#x27;issue 1&#x27;</span>, content=<span class="string">&quot;This is issue 1.&quot;</span>) <span class="comment"># 建立第一筆資料</span></span><br><span class="line">db.session.add(issue) <span class="comment"># 把資料加入資料庫</span></span><br><span class="line">db.session.commit() <span class="comment"># 確認，提交變更</span></span><br></pre></td></tr></table></figure>

<p>就能在資料庫中建立第一份 issue<br>在下一章節，我們要把資料秀出來</p>
<h2 id="新增-endpoint"><a href="#新增-endpoint" class="headerlink" title="新增 endpoint"></a><font color="#f4a261">新增 endpoint</font></h2><p>一個 API 通常不會只有根目錄有作用<br>於是 endpoint 就派上用場了<br>endpoint 指的是 API 的對外接口<br>API的每個有效路徑都是一個 endpoint<br>那我就可以建立一個 endpoint 叫做 ‘/issues’<br>只要使用者對這個 endpoint 送出請求<br>API 就會回傳相對應的資料<br>具體來說怎麼做呢</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/issues&#x27;</span></span>) </span><span class="comment"># 新增一個端點</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_issues</span>():</span><br><span class="line">    issues = Issue.query.<span class="built_in">all</span>() <span class="comment"># 回傳包含所有Issue物件的列表</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 由於issues是一個列表</span></span><br><span class="line">    <span class="comment"># 但 api 的回傳值必須是 json serializable 所以不能是列表</span></span><br><span class="line">    <span class="comment"># 必須是字串或是 dictionary</span></span><br><span class="line">    <span class="comment"># 即使是 dictionary，裡面的所有 value 也都必須是 json serializale</span></span><br><span class="line">    <span class="comment"># 簡單來說整個回傳值必須要長得跟 json 結構一模一樣，否則就必須是 string</span></span><br><span class="line">    output = []</span><br><span class="line">    <span class="keyword">for</span> issue <span class="keyword">in</span> issues: </span><br><span class="line">        issue_data = &#123;<span class="string">&quot;name&quot;</span>: issue.name, <span class="string">&quot;content&quot;</span>: issue.content&#125;</span><br><span class="line">        output.append(issue_data)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;issues&quot;</span>: output&#125;</span><br></pre></td></tr></table></figure>
<h4 id="補充說明"><a href="#補充說明" class="headerlink" title="補充說明:"></a>補充說明:</h4><p><code>Issue.query.all()</code> 查了很久都不知道這個 query 是誰的語法<br>後來才知道他是<code>db.session.query(Issue)</code>的縮寫<br>一些相關的用法如下:</p>
<p><strong>取得所有 todo 資料</strong><br><code>Todo.query.all()</code></p>
<p><strong>限制 1 筆資料</strong><br><code>Todo.query.limit(1).all()</code></p>
<p><strong>正向/逆向排序</strong><br><code>Todo.query.order_by(Todo.content).all()</code><br><code>Todo.query.order_by(Todo.content.desc()).all()</code></p>
<p><strong>取得第一筆資料</strong><br><code>Todo.query.first()</code></p>
<p><strong>取得 primary key=1 一筆資料</strong><br><code>Todo.query.get(1)</code></p>
<p>如此一來<br>連接到 <a target="_blank" rel="noopener" href="http://127.0.0.1:5000/issues">http://127.0.0.1:5000/issues</a> 時就會看到 {“issues”:[{“name”:”issue 1”, “content”:”This is issue 1.”}]}</p>
<h2 id="GET-parameter"><a href="#GET-parameter" class="headerlink" title="GET+parameter"></a><font color="#f4a261">GET+parameter</font></h2><p>如果我們需要帶參數要怎麼寫呢?<br>那就要在路徑中用 <code>&lt;</code> <code>&gt;</code> 夾住參數<br>這樣就能在function中傳入參數了<br>如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/issues/&lt;id&gt;&#x27;</span></span>) </span><span class="comment"># 把接在 /issues/ 後面的字令作 id</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_issue</span>(<span class="params"><span class="built_in">id</span></span>): <span class="comment"># 傳入 id</span></span><br><span class="line">    <span class="comment"># get_or_404() 跟 get() 類似，差別在於如果 id 不存在不會回傳 None 而是 404 error</span></span><br><span class="line">    issue = Issue.query.get_or_404(<span class="built_in">id</span>) </span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;name&quot;</span>:issue.name,<span class="string">&quot;content&quot;</span>:issue.content&#125;</span><br></pre></td></tr></table></figure>

<p>這樣就可以獲取第一筆資料</p>
<p>補充說明:<br><code>Issue.query.get_or_404(id)</code> 這邊之所以可以用 id 來獲取檔案<br>是因為前面在定義 id 的 Column 的時候，有特別設定 primary_key=True，意思是設為主鍵<br>SQLite 主鍵是用於定義唯一行記錄的一個值。一個表只能有一個主鍵。<br>其實它的功用就像 id 一樣，確保每筆資料都是唯一的不重複。</p>
<h2 id="撰寫-POST-方法"><a href="#撰寫-POST-方法" class="headerlink" title="撰寫 POST 方法"></a><font color="#f4a261">撰寫 POST 方法</font></h2><p>想要新增 POST 方法，作法跟 GET 很像<br>只不過我們要指定 app.route 的 methods 參數</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/issues&#x27;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>) </span><span class="comment"># 設方法為 POST</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_issue</span>():</span><br><span class="line">    <span class="comment"># 根據 request 的 body 的內容建立新的 Issue 物件</span></span><br><span class="line">    issue = Issue(name=request.json[<span class="string">&quot;name&quot;</span>], content=request.json[<span class="string">&quot;content&quot;</span>]) </span><br><span class="line">    db.session.add(issue) <span class="comment"># 加入 db </span></span><br><span class="line">    db.session.commit() <span class="comment"># 確認提交</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;id&quot;</span>: drink.<span class="built_in">id</span>&#125; <span class="comment"># 回傳 id</span></span><br></pre></td></tr></table></figure>

<p>POST 有沒有成功比較難單用瀏覽器測試<br>所以我們可以用 postman 如下 (記得要選擇 POST 再按 send)</p>
<img src="/2021/07/28/%E7%94%A8Python-Flask%E6%89%93%E9%80%A0API-DB%E7%AF%87/post-man-1.png" width="700px">

<h2 id="撰寫-DELETE-方法"><a href="#撰寫-DELETE-方法" class="headerlink" title="撰寫 DELETE 方法"></a><font color="#f4a261">撰寫 DELETE 方法</font></h2><p>最後是刪除<br>做法跟POST類似，都需要給予參數</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/issues/&lt;id&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_issue</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    drink = Drink.query.get_or_404(<span class="built_in">id</span>) </span><br><span class="line">    db.session.delete(drink)</span><br><span class="line">    db.session.commit()</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>:<span class="string">f&quot;Id <span class="subst">&#123;<span class="built_in">id</span>&#125;</span> deleted!&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="感想"><a href="#感想" class="headerlink" title="感想"></a><font color="#f4a261">感想</font></h2><p>終於講完啦!!! 寫了好久天哪<br>寫這兩篇之前我還以為我會的差不多了<br>但一解釋起來才發現細節其實完全不會<br>一邊惡補一邊寫哈哈<br>這就是我想寫部落格的目的 讚</p>
<p>不過現在我只做了非常非常單純也不實用的 api<br>還需要很多加強，實際應用在網頁上也不知道會發生什麼事情<br>就看我未來幾天的造化囉</p>
<p>下一步就是要練習把 api 部屬到網路上了<br>我應該會用 Heroku 這個平台吧<br>之後再整理上來囉~</p>
</font>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://roto93.github.io/2021/07/27/%E7%94%A8Python-Flask%E6%89%93%E9%80%A0API/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Guan-Ting Su">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pi's Blog">
      <meta itemprop="description" content="一些程式自學小記錄">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Pi's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/27/%E7%94%A8Python-Flask%E6%89%93%E9%80%A0API/" class="post-title-link" itemprop="url">用 Python Flask 打造 API</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2021-07-27 15:42:32" itemprop="dateCreated datePublished" datetime="2021-07-27T15:42:32+08:00">2021-07-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2022-10-13 15:53:16" itemprop="dateModified" datetime="2022-10-13T15:53:16+08:00">2022-10-13</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <font size="2" color="#aaa">

<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a><font color="#f4a261">前言</font></h2><p>雖然我是覺得在學好一件事情之前不要亂學其他東西另闢戰場<br>但現實就是永遠有學不完的東西<br>也永遠沒有學好一件事情的時候<br>誰知道我會突然又需要學起 python 呢</p>
<p>事情是這樣<br>最近稍微熟悉一下 RWD 和 React 之後<br>我就開始動工 react 版本的 TAN 了<br>做著做著我便開始思考要怎麼簡化網頁的更新流程</p>
<p>目前的做法是每次收到老師的郵件，我就要手動進到伺服器去改檔案<br>雖然熟了操作起來還蠻快的，但還是有些麻煩而且有可能會東漏西漏<br>原本更慘，在我剛接手這個網站的時候<br>除了要打開每一份 html 檔更改標籤<br>還要手動做篩選，必須自己決定每個 issue 是被歸類在什麼類別<br>是後來我改用 javascript 選擇性 render html tag<br>才讓更新網站的速度變得比較能夠接受<br>但終究我還是需要 ssh 進到伺服器然後把檔案傳上去</p>
<p>所以現在，我打算再更簡化一些<br>開發一個 api 架在雲端<br>只要進行 POST request 就能直接更新檔案<br>然後 react 端就只要 GET 接著渲染出來就好</p>
<h4 id="這代表我要學做-api-啦"><a href="#這代表我要學做-api-啦" class="headerlink" title="這代表我要學做 api 啦!!!"></a>這代表我要學做 api 啦!!!</h4><h2 id="該選什麼框架"><a href="#該選什麼框架" class="headerlink" title="該選什麼框架?"></a><font color="#f4a261">該選什麼框架?</font></h2><p>一開始我就遇到了二選一<br>記得之前hahow的老師建議我可以用 python 寫 api<br>所以我查了一下有一個適合的模組 Flask<br>但後來我又發現有一個 Express.js<br>可以讓我用 javascript 寫 api<br>這讓我有點猶豫 (畢竟我現在 JS 比 python 熟很多)</p>
<p>但最後我選了 flask<br>正是因為 python 已經漸漸被我淡忘了<br>如果再不找機會練習的話，真的就要變回一張白紙了<br>那麼以下就是我建立第一個 flask API 的心路歷程</p>
<p>我會把步驟拆成:</p>
<ol>
<li>前置作業</li>
<li>撰寫 API</li>
<li>連接 database</li>
</ol>
<h2 id="前置作業"><a href="#前置作業" class="headerlink" title="前置作業"></a><font color="#f4a261">前置作業</font></h2><p>建立專案資料夾並進入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir my-first-flask-api</span><br></pre></td></tr></table></figure>

<p>這次決定自建API，也終於讓我知道虛擬環境的概念<br>基本上它就像是 node 專案裡的 node_module 資料夾<br>存放一些專案的 dependency<br>只不過跟node不同的是<br>node每個專案都有獨立的環境，所以不同專案間的依賴是互不影響的<br>但 python 就比較複雜，如果直接 pip 安裝任何模組<br>他們會被裝在 <code>...python/lib/site-packages...</code> 之類的地方<br>有點像 global install 的感覺<br>但其實沒那麼簡單，因為 python 又可以同時存在好幾個版本<br>結果就是各個專案間互相牽制，造成一堆問題</p>
<p>所以我們先來建置虛擬環境!<br>在眾多模組當中我選了 <code>virtualenv</code> 這個模組</p>
<p>首先 pip 安裝</p>
<p><code>pip install virtualenv</code></p>
<p>對於什麼時候要用 pip 安裝，什麼時候要用 pip3，之後我再寫一篇短文紀錄好了<br>大部分時候先用 pip 是 ok 的<br>有問題時再試 pip3</p>
<p>安裝好後執行以下指令，以在專案資料夾中建立一個虛擬環境資料夾</p>
<p><code>virtualenv .venv</code></p>
<p>他會根據你的作業系統<br>建立不同結構的.venv資料夾</p>
<h3 id="啟用虛擬環境"><a href="#啟用虛擬環境" class="headerlink" title="啟用虛擬環境"></a>啟用虛擬環境</h3><h4 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h4><p>如果用 cmd<br><code>.\.venv\Scripts\activate.bat</code></p>
<p>如果用 powershell (VScode是用這個)<br><code>.\.venv\Scripts\activate.ps1</code><br>或<br><code>. .\.venv\Scripts\activate</code></p>
<h4 id="MacOS"><a href="#MacOS" class="headerlink" title="MacOS"></a>MacOS</h4><p><code>source ./.venv/bin/activate</code><br>或<br><code>. ./.venv/bin/activate</code></p>
<p>執行完如果在命令列的最開頭看到 <code>(.venv)</code><br>就代表成功了</p>
<p>接下來安裝本次最重要的模組 Flask</p>
<p><code>pip install flask</code></p>
<p>完成後可以輸入 <code>pip show flask</code><br>檢查模組是否如期被安裝在 .venv 虛擬環境中<br>如果在這之前沒有先啟用虛擬環境的話<br>flask 就會被安裝在 site-package 那裏</p>
<p>安裝完所需的模組後執行:<br><code>pip freeze &gt; requirements.txt</code></p>
<p><code>pip freeze</code> 有點像為目前的開發環境拍張 snapshot<br>紀錄所使用的模組有哪些<br>就好像凍結這一瞬間一樣(莫名有點浪漫?)<br>後面的 <code>&gt;</code> 代表要把左側的輸出值寫入右側的檔案<br>也就是 <code>requirements.txt</code> 中</p>
<p>這是為了讓其他人 clone 這份專案後能夠以<br><code>pip install -r requirements.txt</code> (-r: –requirement)<br>安裝專案所需的模組</p>
<p>這邊要注意，最好是使用複數的 requirements<br>雖然打什麼檔名都可以 <code>pip install -r</code><br>但有些時候會嚴格檢查(如Heroku)<br>所以還是要照規矩來比較好</p>
<h2 id="撰寫API"><a href="#撰寫API" class="headerlink" title="撰寫API"></a><font color="#f4a261">撰寫API</font></h2><p>我們建立一個 python file <code>app.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:   <span class="comment"># 當這份程式被作為主程式執行時</span></span><br><span class="line">    app.run(debug=Ture)   <span class="comment"># 執行app，debug=True會讓app處於監聽狀態</span></span><br></pre></td></tr></table></figure>

<p>接著我們建立根路徑</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>) </span><span class="comment"># Decorator。 在這個路徑下接收到 request (預設為GET) 的話要做以下的事</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello world from Flask&quot;</span></span><br></pre></td></tr></table></figure>

<p>目前整個程式非常單純<br>就是引入flask後啟動它<br>並設定當根路徑獲得GET請求時要回傳什麼資訊</p>
<p>接下來我們回到 terminal<br>執行 <code>python app.py</code><br>便能開啟API並等待請求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FSADeprecationWarning: SQLALCHEMY_TRACK_MODIFICATIONS adds significant overhead and will be disabled by default in the future.  Set it to True or False to suppress this warning.</span><br><span class="line">  warnings.warn(FSADeprecationWarning(</span><br><span class="line"> * Debugger is active!</span><br><span class="line"> * Debugger PIN: 124-333-105</span><br><span class="line"> * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)</span><br></pre></td></tr></table></figure>

<p>打開瀏覽器並進到 <a target="_blank" rel="noopener" href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a><br>就會看到輸出的字串了!</p>
<h2 id="待續"><a href="#待續" class="headerlink" title="待續"></a><font color="#f4a261">待續</font></h2><p>文章先寫到這吧不想讓這篇變太長<br>串接資料庫的部分就留到下一篇囉<br>到時也會把 API 的 POST, DELETE 方法給做出來</p>
</font>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Guan-Ting Su</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 強力驅動
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
